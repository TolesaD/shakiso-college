<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head', {title: 'Manage Photos'}) %>
    <style>
        .admin-main { padding: 2rem 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .card { background: white; padding: 2rem; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .photo-list { margin-top: 2rem; }
        .photo-item { border: 1px solid #eee; border-radius: 5px; padding: 1.5rem; margin-bottom: 1.5rem; position: relative; transition: all 0.3s ease; }
        .photo-item img { max-width: 150px; height: auto; border-radius: 4px; }
        .photo-item h3 { margin-top: 0; color: #2c3e50; }
        .photo-meta { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1rem; }
        .photo-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .featured-badge { position: absolute; top: 10px; right: 10px; background: #27ae60; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; text-decoration: none; display: inline-block; transition: all 0.2s; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-secondary { background-color: #95a5a6; color: white; }
        .alert { padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .btn-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; padding: 0; margin-left: 1rem; }
        .spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin-right: 0.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .deleting { opacity: 0.5; transform: scale(0.98); }
        .deleted { height: 0; padding: 0; margin: 0; border: 0; overflow: hidden; transition: all 0.3s ease; }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <nav class="admin-nav">
                <a href="/admin/dashboard" class="logo">Admin Dashboard</a>
                <ul class="admin-nav-links">
                    <li><a href="/admin/dashboard">Dashboard</a></li>
                    <li><a href="/admin/announcements">Announcements</a></li>
                    <li><a href="/admin/photos" class="active">Photos</a></li>
                    <li><a href="/admin/videos">Videos</a></li>
                    <li><a href="/admin/logout">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <div class="container">
            <!-- Flash messages container -->
            <div id="flash-messages">
                <% if (messages && messages.success && messages.success.length > 0) { %>
                    <% messages.success.forEach(message => { %>
                        <div class="alert alert-success" data-message-id="success-<%= Date.now() %>">
                            <%= message %>
                            <button type="button" class="btn-close" onclick="this.parentElement.remove()">×</button>
                        </div>
                    <% }) %>
                <% } %>
                <% if (messages && messages.error && messages.error.length > 0) { %>
                    <% messages.error.forEach(message => { %>
                        <div class="alert alert-danger" data-message-id="error-<%= Date.now() %>">
                            <%= message %>
                            <button type="button" class="btn-close" onclick="this.parentElement.remove()">×</button>
                        </div>
                    <% }) %>
                <% } %>
            </div>

            <div class="card">
                <h2>Upload New Photo</h2>
                <form action="/admin/photos" method="POST" enctype="multipart/form-data" autocomplete="off">
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" name="title" class="form-control" value="<%= typeof formData !== 'undefined' && formData.title ? formData.title : '' %>">
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" class="form-control"><%= typeof formData !== 'undefined' && formData.description ? formData.description : '' %></textarea>
                    </div>
                    <div class="form-group">
                        <label for="image">Image <span style="color:red">*</span></label>
                        <input type="file" id="image" name="image" class="form-control" accept="image/*" required>
                    </div>
                    <div class="form-group">
                        <label for="isFeatured">Featured</label>
                        <input type="checkbox" id="isFeatured" name="isFeatured">
                    </div>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        Upload Photo
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>All Photos</h2>
                <div class="photo-list" id="photos-container">
                    <% if (photos && photos.length > 0) { %>
                        <% photos.forEach(function(photo) { %>
                            <div class="photo-item" id="photo-<%= photo._id %>">
                                <img src="<%= photo.imageUrl %>" alt="<%= photo.title || 'Photo' %>" onerror="this.style.display='none';console.error('Failed to load photo: <%= photo.imageUrl %>')">
                                <h3><%= photo.title || 'No Title' %></h3>
                                <div class="photo-meta">
                                    Uploaded on <%= photo.createdAt ? photo.createdAt.toLocaleString() : 'No Date' %>
                                    by <%= photo.uploadedBy ? photo.uploadedBy.username : 'Unknown' %>
                                </div>
                                <div>
                                    <%= photo.description || 'No Description' %>
                                </div>
                                <% if (photo.isFeatured) { %>
                                    <span class="featured-badge">Featured</span>
                                <% } %>
                                <!-- Debug Info -->
                                <p style="color: gray; font-size: 0.8rem;">
                                    Debug: ID=<%= photo._id %>, isFeatured=<%= photo.isFeatured %>, UploadedByID=<%= photo.uploadedBy ? photo.uploadedBy._id : 'N/A' %>
                                </p>
                                <div class="photo-actions">
                                    <a href="/admin/photos/<%= photo._id %>/edit" class="btn btn-secondary">Edit</a>
                                    <form class="delete-form" data-id="<%= photo._id %>">
                                        <button type="submit" class="btn btn-danger delete-btn" onclick="return confirm('Are you sure you want to delete this photo?');">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>No photos found.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Handle form submission with feedback
        document.querySelectorAll('form[action="/admin/photos"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('#submit-btn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner"></span> Uploading...';
            });
        });

        // Handle AJAX deletion
        document.querySelectorAll('.delete-form').forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const photoId = this.getAttribute('data-id');
                const submitBtn = this.querySelector('.delete-btn');
                const photoItem = document.getElementById(`photo-${photoId}`);
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner"></span> Deleting...';
                photoItem.classList.add('deleting');

                try {
                    const response = await fetch(`/admin/photos/${photoId}?_method=DELETE`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        photoItem.classList.add('deleted');
                        setTimeout(() => {
                            photoItem.remove();
                            showFlashMessage(data.message, 'success');
                        }, 300);
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Delete';
                        photoItem.classList.remove('deleting');
                        showFlashMessage(data.message || 'Failed to delete photo', 'danger');
                    }
                } catch (err) {
                    console.error('Delete error:', err);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Delete';
                    photoItem.classList.remove('deleting');
                    showFlashMessage('Failed to delete photo: ' + err.message, 'danger');
                }
            });
        });

        // Show flash message function
        function showFlashMessage(message, type) {
            const flashContainer = document.getElementById('flash-messages');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.setAttribute('data-message-id', `${type}-${Date.now()}`);
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            flashContainer.insertBefore(alertDiv, flashContainer.firstChild);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Check for flash messages after page load
        window.addEventListener('load', () => {
            // Ensure flash messages are visible
            const flashContainer = document.getElementById('flash-messages');
            const alerts = flashContainer.querySelectorAll('.alert');
            if (alerts.length === 0) {
                console.log('No flash messages found on page load');
            } else {
                alerts.forEach(alert => {
                    alert.style.opacity = '1';
                    setTimeout(() => {
                        alert.style.opacity = '0';
                        setTimeout(() => {
                            if (alert.parentNode) {
                                alert.remove();
                            }
                        }, 300);
                    }, 5000);
                });
            }

            // Debugging: Log session ID to verify session persistence
            console.log('Session ID:', '<%= typeof req !== "undefined" && req.sessionID ? req.sessionID : "Not available" %>');
        });
    </script>
</body>
</html>